<%- include('../partials/header', {title: title}) %>

<div class="grid grid-cols-1 min-h-screen lg:grid-cols-5">
  <%- include('../partials/sidebar') %>
  <main class="col-span-1 p-4 sm:p-6 lg:col-span-4 lg:p-8 relative">
    
    <header class="flex items-center justify-between border-b-2 border-black pb-6">
      <div>
        <h1 class="text-4xl font-extrabold uppercase">Download List</h1>
        <p class="text-neutral-600">VIEW & MANAGE ALL DOWNLOADS</p>
      </div>
      <div class="flex gap-2">
        <a href="/admin/links/new" class="hidden sm:inline-block border-2 border-black px-4 py-2 text-lg font-bold uppercase hover:bg-yellow-300 transition-colors">Add a Download</a>
        <button @click="mobileMenuOpen = !mobileMenuOpen" class="border-2 border-black px-4 py-2 text-lg font-bold uppercase hover:bg-yellow-300 lg:hidden">Menu</button>
      </div>
    </header>

    <section class="mt-6 border-2 border-black p-4 bg-neutral-50" x-data="{ showFilters: <%= filters.search || filters.status !== 'all' || filters.dateFrom || filters.dateTo ? 'true' : 'false' %> }">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold uppercase">Search & Filter</h2>
        <button @click="showFilters = !showFilters" class="text-sm font-bold uppercase underline hover:bg-yellow-300 px-2 py-1">
          <span x-text="showFilters ? 'Hide' : 'Show'"></span>
        </button>
      </div>

      <form method="GET" action="/admin/links" x-show="showFilters" x-cloak>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

          <div>
            <label class="block text-xs font-bold uppercase mb-1">Search</label>
            <input
              type="text"
              name="search"
              value="<%= filters.search || '' %>"
              placeholder="Filename or Short ID..."
              class="w-full border-2 border-black p-2 focus:bg-yellow-100"
            />
          </div>

          <div>
            <label class="block text-xs font-bold uppercase mb-1">Status</label>
            <select name="status" class="w-full border-2 border-black p-2 focus:bg-yellow-100">
              <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All</option>
              <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>Active</option>
              <option value="expired" <%= filters.status === 'expired' ? 'selected' : '' %>>Expired</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-bold uppercase mb-1">Created From</label>
            <input
              type="date"
              name="dateFrom"
              value="<%= filters.dateFrom ? new Date(filters.dateFrom).toISOString().split('T')[0] : '' %>"
              class="w-full border-2 border-black p-2 focus:bg-yellow-100"
            />
          </div>

          <div>
            <label class="block text-xs font-bold uppercase mb-1">Created To</label>
            <input
              type="date"
              name="dateTo"
              value="<%= filters.dateTo ? new Date(filters.dateTo).toISOString().split('T')[0] : '' %>"
              class="w-full border-2 border-black p-2 focus:bg-yellow-100"
            />
          </div>
        </div>

        <div class="flex gap-2 mt-4">
          <button type="submit" class="border-2 border-black bg-yellow-300 px-6 py-2 font-bold uppercase hover:bg-black hover:text-yellow-300 transition-colors">
            Apply Filters
          </button>
          <a href="/admin/links" class="border-2 border-black bg-neutral-200 px-6 py-2 font-bold uppercase hover:bg-white transition-colors inline-block">
            Clear All
          </a>
        </div>
      </form>
    </section>

    <section class="mt-6" x-data="batchOperations()" @link-deleted="linkCount--">

      <div
        x-show="toast.show"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        :class="toast.type === 'success' ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800'"
        class="fixed top-4 right-4 z-50 border-2 px-6 py-4 font-bold shadow-lg max-w-md"
        x-cloak
      >
        <div class="flex items-center justify-between gap-4">
          <span x-text="toast.message"></span>
          <button @click="toast.show = false" class="font-bold hover:opacity-70">&times;</button>
        </div>
      </div>

      <div
        x-show="confirm.show"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        x-cloak
      >
        <div class="bg-white border-2 border-black p-6 shadow-lg max-w-md w-full mx-4">
          <h3 class="text-xl font-bold uppercase mb-2" x-text="confirm.title"></h3>
          <p class="text-neutral-600 mb-6" x-text="confirm.message"></p>
          <div class="flex gap-2 justify-end">
            <button
              @click="handleConfirm(false)"
              class="border-2 border-black bg-neutral-200 px-4 py-2 font-bold uppercase hover:bg-white transition-colors"
            >
              Cancel
            </button>
            <button
              @click="handleConfirm(true)"
              :class="confirm.isDanger ? 'bg-red-600 text-white hover:bg-black hover:text-red-500' : 'bg-yellow-300 hover:bg-black hover:text-yellow-300'"
              class="border-2 border-black px-4 py-2 font-bold uppercase transition-colors"
            >
              Confirm
            </button>
          </div>
        </div>
      </div>

      <div x-show="selectedIds.length > 0" x-cloak class="mb-4 border-2 border-black bg-yellow-100 p-4">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <span class="font-bold">
            <span x-text="selectedIds.length"></span> item(s) selected
          </span>
          <div class="flex gap-2">
            <button @click="batchDelete()" class="border-2 border-black bg-red-500 px-4 py-2 font-bold uppercase text-white hover:bg-black hover:text-red-500 transition-colors">
              Move to Trash
            </button>
            <button @click="clearSelection()" class="border-2 border-black bg-neutral-200 px-4 py-2 font-bold uppercase hover:bg-white transition-colors">
              Clear Selection
            </button>
          </div>
        </div>
      </div>

      <div x-show="linkCount > 0" class="overflow-x-auto border-2 border-black shadow-md">
        <table class="w-full">
          <thead class="bg-black text-yellow-300">
            <tr>
              <th class="p-4 text-left uppercase w-12">
                <input type="checkbox" @change="toggleAll($event)" class="w-5 h-5 cursor-pointer" />
              </th>
              <th class="p-4 text-left uppercase">File</th>
              <th class="p-4 text-left uppercase">URLs</th>
              <th class="p-4 text-left uppercase">Expires</th>
              <th class="p-4 text-left uppercase">Stats</th>
              <th class="p-4 text-left uppercase">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% links.forEach(link => { %>
            <tr
              class="border-b-2 border-black last:border-b-0 hover:bg-neutral-50 transition-colors"
              data-link-id="<%= link.id %>"
              x-data="listItem({ id: '<%= link.id %>', csrfToken: '<%= csrfToken %>' })"
            >
              <td class="align-top p-4 pt-8 text-center">
                <input
                  type="checkbox"
                  :checked="isSelected('<%= link.id %>')"
                  @change="toggleSelection('<%= link.id %>')"
                  class="w-5 h-5 cursor-pointer"
                />
              </td>
              <td class="align-top space-y-2 pt-8 font-bold text-center max-w-xs break-words">
                <%= link.original_name %>
              </td>

              <td class="align-top space-y-4 p-4 min-w-[350px]">
                <% if (link.landing_page_url !== 'N/A') { %>
                <div class="w-full">
                  <label class="text-xs font-bold uppercase flex justify-between items-center mb-1">
                    <span>Landing Page</span>
                    <button @click="generateQr('<%= link.landing_page_url %>')" class="text-xs underline hover:bg-yellow-300 px-1">QR Code</button>
                  </label>
                  <div class="flex">
                    <input type="text" readonly value="<%= link.landing_page_url %>" class="flex-grow border-2 border-black border-r-0 bg-white p-2 font-mono text-sm focus:bg-yellow-100" onclick="this.select()" />
                    <button 
                      @click="copyToClipboard('<%= link.landing_page_url %>', 'btnLpText')" 
                      class="border-2 border-black bg-neutral-200 px-3 py-1 text-xs font-bold uppercase hover:bg-black hover:text-white min-w-[70px] transition-colors"
                      x-text="btnLpText"
                    >Copy</button>
                  </div>
                </div>
                <% } %>
                
                <div class="w-full">
                  <label class="text-xs font-bold uppercase mb-1 block">Direct Download</label>
                  <div class="flex">
                    <input type="text" readonly value="<%= link.direct_download_url %>" class="flex-grow border-2 border-black border-r-0 bg-white p-2 font-mono text-sm focus:bg-yellow-100" onclick="this.select()" />
                    <button 
                      @click="copyToClipboard('<%= link.direct_download_url %>', 'btnDlText')" 
                      class="border-2 border-black bg-neutral-200 px-3 py-1 text-xs font-bold uppercase hover:bg-black hover:text-white min-w-[70px] transition-colors"
                      x-text="btnDlText"
                    >Copy</button>
                  </div>
                </div>

                <div x-show="showQr" x-cloak class="mt-2 border-2 border-black p-2 bg-white inline-block shadow-lg">
                    <div class="flex justify-between mb-1 items-center border-b border-black pb-1">
                        <span class="font-bold text-xs">Scan Me</span>
                        <button @click="showQr = false" class="text-sm font-bold text-red-600 hover:text-black">&times;</button>
                    </div>
                    <img :src="qrUrl" class="w-24 h-24 block" alt="QR Code" />
                </div>
              </td>

              <td class="align-top space-y-2 pt-8 text-center text-sm">
                <% if (link.is_expired) { %> 
                  <span class="font-bold uppercase text-red-600 border border-red-600 px-2 py-1">Expired</span>
                <% } else if (link.expires_at) { %> 
                  <span class="block"><%= new Date(link.expires_at).toLocaleDateString() %></span>
                  <span class="block text-xs text-neutral-500"><%= new Date(link.expires_at).toLocaleTimeString() %></span>
                <% } else { %> 
                  <span class="font-bold">Never</span> 
                <% } %>
              </td>

              <td class="align-top space-y-2 pt-8 text-center">
                <div class="text-sm">Down: <b><%= link.download_count %></b></div>
                <div class="text-sm">Visit: <b><%= link.visit_count %></b></div>
              </td>

              <td class="align-top p-6 pr-3">
                <div x-show="!showConfirm" class="space-y-2">
                  <a href="/admin/links/edit/<%= link.id %>" class="text-center block w-full border-2 border-black bg-yellow-300 p-2 text-sm font-bold uppercase hover:bg-black hover:text-yellow-300 transition-colors">Edit</a>
                  <button @click="showConfirm = true" class="w-full border-2 border-black bg-red-500 p-2 text-sm font-bold uppercase text-white hover:bg-black hover:text-red-500 transition-colors">Delete</button>
                </div>

                <div x-show="showConfirm" x-cloak class="space-y-2">
                  <p class="text-center font-bold uppercase text-red-600 text-xs">Sure?</p>
                  <button @click="deleteLink()" :disabled="isDeleting" class="w-full border-2 border-black bg-red-600 p-2 text-sm font-bold uppercase text-white disabled:opacity-50">
                    <span x-text="isDeleting ? '...' : 'Yes'"></span>
                  </button>
                  <button @click="showConfirm = false" :disabled="isDeleting" class="w-full border-2 border-black bg-neutral-200 p-2 text-sm font-bold uppercase hover:bg-white">Cancel</button>
                </div>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div x-show="linkCount === 0" x-cloak class="border-2 border-black bg-yellow-50 p-8 text-center">
        <h3 class="mb-4 text-2xl font-bold uppercase">No Downloads Found</h3>
        <p class="mx-auto mb-6 max-w-md text-neutral-600">
          <% if (filters.search || filters.status !== 'all' || filters.dateFrom || filters.dateTo) { %>
            No results match your search criteria. Try adjusting your filters.
          <% } else { %>
            It looks like you haven't created any download links yet.
          <% } %>
        </p>
        <% if (!filters.search && filters.status === 'all' && !filters.dateFrom && !filters.dateTo) { %>
        <a href="/admin/links/new" class="inline-block border-2 border-black bg-yellow-300 px-6 py-4 text-xl font-bold uppercase text-black hover:shadow-[8px_8px_0px_#000] transition-shadow">
          Add Your First Download
        </a>
        <% } %>
      </div>

      <% if (pagination.totalPages > 1) { %>
      <div class="mt-6 flex items-center justify-between border-t-2 border-black pt-6">
        <div class="text-sm text-neutral-600">
          Showing <b><%= ((pagination.page - 1) * pagination.limit) + 1 %></b> to <b><%= Math.min(pagination.page * pagination.limit, pagination.total) %></b> of <b><%= pagination.total %></b> results
        </div>

        <div class="flex gap-2">
          <%
          // Build query string with filters preserved
          const buildQueryString = (page) => {
            const params = new URLSearchParams();
            params.set('page', page);
            if (filters.search) params.set('search', filters.search);
            if (filters.status && filters.status !== 'all') params.set('status', filters.status);
            if (filters.dateFrom) params.set('dateFrom', new Date(filters.dateFrom).toISOString().split('T')[0]);
            if (filters.dateTo) params.set('dateTo', new Date(filters.dateTo).toISOString().split('T')[0]);
            return '?' + params.toString();
          };
          %>

          <% if (pagination.hasPrev) { %>
            <a href="<%= buildQueryString(pagination.page - 1) %>" class="border-2 border-black bg-neutral-200 px-4 py-2 font-bold uppercase hover:bg-yellow-300 transition-colors">
              &laquo; Prev
            </a>
          <% } else { %>
            <span class="border-2 border-neutral-300 bg-neutral-100 px-4 py-2 font-bold uppercase text-neutral-400 cursor-not-allowed">
              &laquo; Prev
            </span>
          <% } %>

          <div class="hidden sm:flex gap-2">
            <%
            const maxPages = 5;
            let startPage = Math.max(1, pagination.page - 2);
            let endPage = Math.min(pagination.totalPages, startPage + maxPages - 1);

            if (endPage - startPage < maxPages - 1) {
              startPage = Math.max(1, endPage - maxPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) { %>
              <% if (i === pagination.page) { %>
                <span class="border-2 border-black bg-yellow-300 px-4 py-2 font-bold">
                  <%= i %>
                </span>
              <% } else { %>
                <a href="<%= buildQueryString(i) %>" class="border-2 border-black bg-white px-4 py-2 font-bold hover:bg-yellow-100 transition-colors">
                  <%= i %>
                </a>
              <% } %>
            <% } %>
          </div>

          <span class="sm:hidden border-2 border-black bg-yellow-300 px-4 py-2 font-bold">
            <%= pagination.page %> / <%= pagination.totalPages %>
          </span>

          <% if (pagination.hasNext) { %>
            <a href="<%= buildQueryString(pagination.page + 1) %>" class="border-2 border-black bg-neutral-200 px-4 py-2 font-bold uppercase hover:bg-yellow-300 transition-colors">
              Next &raquo;
            </a>
          <% } else { %>
            <span class="border-2 border-neutral-300 bg-neutral-100 px-4 py-2 font-bold uppercase text-neutral-400 cursor-not-allowed">
              Next &raquo;
            </span>
          <% } %>
        </div>
      </div>
      <% } %>

    </section>
  </main>
</div>
<%- include('../partials/footer') %>
