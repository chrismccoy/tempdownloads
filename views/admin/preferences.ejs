<%- include('../partials/header', {title: title}) %>

<div class="grid grid-cols-1 min-h-screen lg:grid-cols-5">
  <%- include('../partials/sidebar') %>
  <main class="col-span-1 p-4 sm:p-6 lg:col-span-4 lg:p-8 relative">

    <header class="flex items-center justify-between border-b-2 border-black pb-6">
      <div>
        <h1 class="text-4xl font-extrabold uppercase">My Preferences</h1>
        <p class="text-neutral-600">CUSTOMIZE YOUR EXPERIENCE</p>
      </div>
      <button @click="mobileMenuOpen = !mobileMenuOpen" class="border-2 border-black px-4 py-2 text-lg font-bold uppercase hover:bg-yellow-300 lg:hidden">Menu</button>
    </header>

    <section class="mt-8" x-data="preferencesForm()">

      <div
        x-show="toast.show"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        :class="toast.type === 'success' ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800'"
        class="fixed top-4 right-4 z-50 border-2 px-6 py-4 font-bold shadow-lg max-w-md"
        x-cloak
      >
        <div class="flex items-center justify-between gap-4">
          <span x-text="toast.message"></span>
          <button @click="toast.show = false" class="font-bold hover:opacity-70">&times;</button>
        </div>
      </div>

      <form @submit.prevent="submitForm" class="max-w-3xl">

        <div class="mb-8 border-2 border-black p-6 bg-white">
          <h2 class="text-2xl font-bold uppercase mb-4">Default Settings</h2>

          <div class="mb-4">
            <label class="block text-sm font-bold uppercase mb-2">
              Default Expiry Time
              <span class="text-neutral-500 font-normal ml-2">(for new downloads)</span>
            </label>
            <select name="default_expiry_seconds" x-model="formData.default_expiry_seconds" class="w-full border-2 border-black p-2 focus:bg-yellow-100">
              <option value="">Permanent (Never Expires)</option>
              <option value="60">1 Minute</option>
              <option value="3600">1 Hour</option>
              <option value="10800">3 Hours</option>
              <option value="43200">12 Hours</option>
              <option value="86400">1 Day</option>
              <option value="604800">1 Week</option>
              <option value="2592000">30 Days</option>
              <option value="31536000">1 Year</option>
            </select>
            <p class="text-xs text-neutral-600 mt-1">
              Default: <b><%= defaults.default_expiry_seconds === null ? 'Permanent' : defaults.default_expiry_seconds + ' seconds' %></b>
            </p>
          </div>

          <div class="mb-4">
            <label class="flex items-center cursor-pointer">
              <input
                type="checkbox"
                name="default_has_landing_page"
                x-model="formData.default_has_landing_page"
                class="w-5 h-5 mr-3 cursor-pointer"
              />
              <span class="font-bold uppercase">Enable Landing Page by Default</span>
            </label>
            <p class="text-xs text-neutral-600 mt-1 ml-8">
              Landing pages provide QR codes and preview before download. Default: <b><%= defaults.default_has_landing_page ? 'Enabled' : 'Disabled' %></b>
            </p>
          </div>
        </div>

        <div class="mb-8 border-2 border-black p-6 bg-white">
          <h2 class="text-2xl font-bold uppercase mb-4">Display Settings</h2>

          <div class="mb-4">
            <label class="block text-sm font-bold uppercase mb-2">
              Items Per Page
            </label>
            <input
              type="number"
              name="items_per_page"
              x-model="formData.items_per_page"
              min="5"
              max="100"
              class="w-full border-2 border-black p-2 focus:bg-yellow-100"
            />
            <p class="text-xs text-neutral-600 mt-1">
              Number of links to show per page (5-100). Default: <b><%= defaults.items_per_page %></b>
            </p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-bold uppercase mb-2">
              Theme
            </label>
            <select name="theme" x-model="formData.theme" class="w-full border-2 border-black p-2 focus:bg-yellow-100">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
            <p class="text-xs text-neutral-600 mt-1">
              Color scheme preference. Default: <b><%= defaults.theme %></b>
            </p>
          </div>
        </div>

        <div class="mb-8 border-2 border-black p-6 bg-white">
          <h2 class="text-2xl font-bold uppercase mb-4">Notifications</h2>

          <div class="mb-4">
            <label class="flex items-center cursor-pointer">
              <input
                type="checkbox"
                name="email_notifications"
                x-model="formData.email_notifications"
                class="w-5 h-5 mr-3 cursor-pointer"
              />
              <span class="font-bold uppercase">Email Notifications</span>
            </label>
            <p class="text-xs text-neutral-600 mt-1 ml-8">
              Receive email alerts for expiring links and security events. Default: <b><%= defaults.email_notifications ? 'Enabled' : 'Disabled' %></b>
            </p>
          </div>
        </div>

        <div class="flex gap-4">
          <button
            type="submit"
            :disabled="isSubmitting"
            class="border-2 border-black bg-yellow-300 px-8 py-3 text-lg font-bold uppercase hover:bg-black hover:text-yellow-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <span x-text="isSubmitting ? 'Saving...' : 'Save Preferences'"></span>
          </button>

          <button
            type="button"
            @click="resetToDefaults()"
            :disabled="isSubmitting"
            class="border-2 border-black bg-neutral-200 px-8 py-3 text-lg font-bold uppercase hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            Reset to Defaults
          </button>
        </div>
      </form>

    </section>
  </main>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('preferencesForm', () => ({
    isSubmitting: false,
    toast: {
      show: false,
      message: '',
      type: 'success'
    },
    formData: {
      default_expiry_seconds: '<%= preferences.default_expiry_seconds === null ? '' : preferences.default_expiry_seconds %>',
      default_has_landing_page: <%= preferences.default_has_landing_page %>,
      items_per_page: <%= preferences.items_per_page %>,
      email_notifications: <%= preferences.email_notifications %>,
      theme: '<%= preferences.theme %>'
    },

    showToast(message, type = 'success') {
      this.toast.message = message;
      this.toast.type = type;
      this.toast.show = true;

      // Auto-hide after 4 seconds
      setTimeout(() => {
        this.toast.show = false;
      }, 4000);
    },

    async submitForm() {
      this.isSubmitting = true;

      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const res = await fetch('/admin/preferences', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'x-csrf-token': csrfToken
          },
          body: JSON.stringify(this.formData)
        });

        const data = await res.json();

        if (data.success) {
          this.showToast(data.message, 'success');
        } else {
          this.showToast('Error: ' + (data.error?.message || data.message), 'error');
        }
      } catch (e) {
        this.showToast('Network error: ' + e.message, 'error');
      } finally {
        this.isSubmitting = false;
      }
    },

    async resetToDefaults() {
      if (!confirm('Reset all preferences to default values?')) return;

      this.isSubmitting = true;

      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const res = await fetch('/admin/preferences/reset', {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'x-csrf-token': csrfToken
          }
        });

        const data = await res.json();

        if (data.success) {
          this.showToast(data.message, 'success');
          // Reload after a short delay so user sees the toast
          setTimeout(() => window.location.reload(), 1500);
        } else {
          this.showToast('Error: ' + (data.error?.message || data.message), 'error');
        }
      } catch (e) {
        this.showToast('Network error: ' + e.message, 'error');
      } finally {
        this.isSubmitting = false;
      }
    }
  }));
});
</script>

<%- include('../partials/footer') %>
